<!doctype html><html lang=en class="js csstransforms3d">
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=generator content="Hugo 0.93.3">
<meta name=description content>
<link rel=icon href=/images/favicon.png type=image/png>
<title>28_读写分离有哪些坑？ :: Gen 的学习笔记</title><link href=/css/nucleus.css?1646795377 rel=stylesheet>
<link href=/css/fontawesome-all.min.css?1646795377 rel=stylesheet>
<link href=/css/hybrid.css?1646795377 rel=stylesheet>
<link href=/css/featherlight.min.css?1646795377 rel=stylesheet>
<link href=/css/perfect-scrollbar.min.css?1646795377 rel=stylesheet>
<link href=/css/auto-complete.css?1646795377 rel=stylesheet>
<link href=/css/atom-one-dark-reasonable.css?1646795377 rel=stylesheet>
<link href=/css/theme.css?1646795377 rel=stylesheet>
<link href=/css/tabs.css?1646795377 rel=stylesheet>
<link href=/css/hugo-theme.css?1646795377 rel=stylesheet>
<link href=/css/theme-green.css?1646795377 rel=stylesheet>
<script src=/js/jquery-3.3.1.min.js?1646795377></script>
<style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/1/28/>
<nav id=sidebar>
<div id=header-wrapper>
<div id=header>
<a id=logo href=/><svg id="grav-logo" style="width:100%;height:100%" viewBox="0 0 504 140" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421"><path id="path189" style="fill:#000;stroke-width:.204716" d="m82.052734 5.96875c-.854728.206286-1.398833 1.0426648-2.119991 1.5136522-1.191736.9811717-2.382712 1.9632671-3.575321 2.9433788 2.594183.350428 5.145702.867699 7.545412 1.808313 5.15394 2.088262 10.087847 4.726839 15.416602 6.374822 1.147804.40744 2.285264.842546 3.422754 1.277803 1.75942-1.384373 3.51938-2.768062 5.27734-4.154297-5.15508-1.970902-10.472419-3.533913-15.466989-5.9135627-3.304489-1.4459104-6.569291-3.1504213-10.136525-3.8383905-.121039-.00522-.24197-.024031-.363282-.011719z"/><path id="path450" style="fill:#000;stroke-width:.204716" d="m196.30273 32.138672c-1.55372 1.106817-3.11032 2.209608-4.66406 3.316406 4.11763 4.405283 7.13993 9.726972 9.45954 15.262663 1.56282 4.287959 2.2182 8.808703 2.86451 13.292499.38887 3.231143.62551 6.590222.0466 9.712715-.96049 4.643178-2.51468 9.199787-4.84902 13.336481-1.78789 2.835013-4.77216 5.01731-8.11326 5.529767-2.16053.194334-4.25815-1.330295-4.80458-3.419166-.29054-.914485-.51906-1.850946-.67999-2.79699 2.1261-1.148168 4.25191-2.296867 6.37891-3.443359.78567-2.636208 1.75001-5.564844.60547-8.248047-.53525-1.298746-2.07776-1.892115-3.39901-1.607978-1.67519.02941-3.3829.406643-4.74129 1.430853-2.09614 1.168313-4.10099 2.916619-4.64291 5.358765-.73735 2.904669-.11138 5.915639.29727 8.820042.49411 2.882218 1.53935 5.996824 4.13517 7.643151 2.35305 1.561098 5.48511 1.763546 8.04109.579307 3.30354-1.331591 6.21912-3.456703 8.96703-5.688008 1.96663-1.643363 3.42478-3.806368 4.42597-6.15213 2.06828-4.393527 3.59057-9.083525 4.21247-13.907794.54472-5.741127-.61574-11.455157-1.66588-17.071718-.80064-3.920321-2.18078-7.71884-4.16423-11.197019-2.05596-3.912809-4.48616-7.631847-7.30162-11.041456-.13607.097-.27214.194011-.40821.291016zm-8.92578 46.195312c.2043 1.815935-.60122 3.548925-1.07929 5.263081-.26336.819832-.52694 1.639598-.78985 2.459576-.30945-2.140868-.59564-4.349894-.22997-6.496983.18103-.524926.30215-1.38075 1.03046-1.299978.29126.03359 1.0366-.341949 1.06865.0743z"/><path id="path452" style="fill:#000;stroke-width:.204716" d="m194.86719 31.490234c-1.70711 1.334537-3.41328 2.670271-5.1211 4.003907 2.86943.883205 5.775 2.063806 7.95683 4.093286 4.34216 3.834897 7.82362 8.740548 9.94201 14.191942 1.76448 4.476901 2.8312 9.131581 3.98461 13.784118.98733 4.367667 1.90544 8.806141 3.88594 12.856576 1.24292 2.622586 2.70301 5.245971 5.0027 7.092602 2.86039 2.399492 6.23621 4.055842 9.38886 6.021597 2.04982 1.173006 4.12056 2.42864 6.39784 3.079398 1.45651.10626 2.44267-1.215991 3.58737-1.828292.94383-.603205 1.48969-1.756053 1.1938-2.859996-.26262-3.334359-1.79835-6.420037-2.55184-9.603237-1.082-3.641846-2.12776-7.319367-2.61203-11.103361-1.00164-5.999038-1.25683-12.026556-1.07049-18.099458.15781-3.468309.76516-7.086829 1.79952-10.394254.64699-1.974316 1.63337-3.824169 2.48746-5.7485 1.81963 1.486138 2.86594 3.671816 3.9004 5.728955.64108 1.500012.97375 3.161278.76757 4.790577-.65333-.253181-1.39605-.122429-1.84271.440021-1.42475 1.127514-2.85059 2.25365-4.27448 3.382244 1.88905.912209 4.07218 1.774111 6.16993 1.046875 1.41721-.500184 2.61209-1.460186 3.82031-2.322265 1.61109-1.433166 2.12717-3.722659 1.84286-5.796283-.25541-3.407249-2.01838-6.471843-3.90241-9.234739-1.20503-1.564932-2.69095-3.179269-4.68989-3.629264-2.29359-.240154-4.23277 1.369272-5.7447 2.892708-1.43661 2.020458-2.19043 4.395461-3.26252 6.599693-1.49815 3.623296-2.20417 7.528274-2.57907 11.414395-.28341 3.951365-.19329 7.924341.002 11.877608.33001 4.919807.95661 9.833736 2.05577 14.642753.86678 3.567725 1.99782 7.062219 3.05361 10.576879-3.15033-1.782655-6.31477-3.575686-9.24095-5.712379-2.79226-2.230651-4.33102-5.569215-5.59547-8.821527-1.43467-3.856976-2.08138-7.93959-3.1517-11.901307-1.2033-4.621024-2.39596-9.284022-4.32968-13.665113-2.65871-5.844039-6.70058-11.067953-11.71736-15.073502-1.61991-1.219808-3.40929-2.21157-5.31445-2.910157-.0794.0625-.15886.125-.23828.1875z"/><path id="path454" style="fill:#000;stroke-width:.204716" d="m254.32422 60.896484c-2.83006.191036-5.03358 2.200857-7.25961 3.693573-2.47583 1.745762-4.35875 4.322203-5.13274 7.262544-.87682 3.10457-.8925 6.386041-.66333 9.580213.28103 2.760325 1.40168 5.413874 3.21193 7.520311 1.70594 2.226415 3.96523 4.02624 6.58223 5.060539 1.96205.825143 4.24546 1.477142 6.30644.60157.53052-.223408-.579.488221-.79955.696267-3.55669 2.717013-6.96075 5.643309-10.03806 8.898339-3.00732 3.02489-5.58812 6.54712-7.09012 10.56555-1.52988 3.64022-2.18897 7.75831-1.16537 11.62585 1.1817 4.89934 4.89376 9.02479 9.55065 10.89607 3.31904 1.41685 6.8989 2.15208 10.47421 2.53862 1.33062.14817 2.74633-.0804 3.79142-.97127 1.26107-.73033 2.85276-1.49217 3.09455-3.10504.98221-4.40417.4144-8.94054.57187-13.40766.0559-9.78704-.13373-19.58303.15814-29.363921.22294-.322518.70593-.47792.98565-.786323 3.15772-2.482196 6.24325-5.094621 9.44181-7.481219.59962-.562387 1.37371-1.333493 1.12122-2.214688-.58838-1.019752-1.9005-.72381-2.80832-.393333-1.78507.665067-3.47142 1.597264-4.9082 2.856236-1.27226.954663-2.48458 2.004466-3.71388 2.992226.0582-1.808273-.2238-3.702052.46966-5.419967 1.29511-4.12273 1.38265-8.583115.37497-12.777365-.40543-2.092479-.5444-4.224875-.57901-6.349544-.12138-1.041696-1.27545-1.792292-2.25563-1.339589-.44131.07748-.73882.621708-1.12056.653678-2.66594-1.25476-5.64308-1.684906-8.56131-1.835573zm.33203 5.285157c2.01725.246306 4.08801.70676 5.74023 1.958984.49385-.198426.10745 1.069897.2356 1.480834.0141 5.004454.0397 10.022836-.26491 15.015164-.54725 1.610021-1.37948 3.119937-2.27537 4.560643-.29357.413619-.64502.972024-1.23854.753886-2.97677-.555212-5.7871-2.226129-7.55638-4.708964-1.73668-1.945495-2.4821-4.544038-2.47151-7.147851-.0102-2.492946.0306-4.99488.91085-7.343489.73261-1.875515 1.96563-3.730677 3.8265-4.614744 1.01134-.351459 2.06471-.0229 3.09353.04554zm5.48437 34.769529c-.0724 10.74931.0496 21.50087-.0827 32.24888-.0316.50518-.0784 1.00973-.14971 1.51089-3.6299-.36444-7.17132-1.2816-10.41387-2.97137-3.31505-1.88151-5.62981-5.38503-6.00686-9.18451-.34732-2.69647.25495-5.42026 1.34629-7.88372 1.31942-3.35117 3.42797-6.40619 5.95909-8.88755 2.88063-3.07638 6.02153-5.910197 9.37903-8.457618-.0104 1.208333-.0208 2.416667-.0313 3.624998z"/><path id="path456" style="fill:#000;stroke-width:.204716" d="m286.45117 62.744141c-.66276.0108-1.0893.579612-1.58984.919921-2.93216-.416883-6.1457-.03654-8.52713 1.859521-1.32775.839426-2.71795 1.775792-3.34291 3.285064-1.96619 3.59837-2.81372 7.799977-2.48463 11.879219.58618 4.391569 3.77417 8.360576 8.02068 9.714478 3.09823 1.057475 6.42957 1.208399 9.67383 1.054687 2.00132-.177732 3.83824-1.164999 5.41409-2.288612 1.93792-1.221245 3.80495-2.745567 4.75664-4.887712 1.27631-2.582436 2.06687-5.395576 2.51547-8.233505.29359-2.654253-1.0275-5.228394-2.7852-7.132573-2.12288-2.207611-4.88968-3.643737-7.64514-4.897051-1.24663-.488298-2.51233-.998051-3.82059-1.270293-.0615.0067-.12392-.01566-.18527-.0031zm-.76172 5.544921c1.33874.466153 2.72682 1.108914 3.99146 1.820734 2.3343 1.241606 4.77095 2.977239 5.44214 5.689032.34285 2.011522-.5266 3.97606-1.06266 5.878051-.57623 1.593021-1.21802 3.351886-2.6703 4.347853-1.85437.702929-3.8863.346015-5.81627.291151-2.9267-.216886-6.09721-1.13898-7.8626-3.659801-1.58319-2.125298-1.94862-4.931501-1.41712-7.483183.34601-2.202505.95334-4.411407 2.16488-6.305711 1.72955-.549238 3.55003-.159042 5.2991.01258.58196.0145 1.07248-.33425 1.44114-.750866.16341.05339.32682.106771.49023.160156z"/><path id="path458" style="fill:#000;stroke-width:.204716" d="m312.22656 63.080078c-2.51287-.06687-4.65817 1.475076-6.57812 2.91211-2.04617 1.597902-3.36366 3.956301-3.96106 6.457589-.69758 2.785863-.78555 5.72098-.38894 8.557054.45501 2.562579 1.62143 5.141346 3.83069 6.648159 2.22165 1.784303 4.86213 3.031589 7.67199 3.533149 3.55108.707794 7.20025.635324 10.80301.591013 2.16637-.158142 4.39539-.452498 6.36267-1.410011 2.07587-1.747288 3.95151-3.712247 5.70312-5.78125-2.79921.445598-5.49844 1.330936-8.26339 1.923705-3.39336.425307-6.83433.249648-10.23012-.04257-3.24745-.407049-6.52917-1.646109-8.82841-4.041056-.87222-1.044913-1.21587-2.282305-1.45637-3.562052-.26964-2.262109-.13957-4.588823.36966-6.808958.33731-1.374369.93104-2.721367 1.91644-3.756179 2.37937-.429241 4.84399.104078 7.07813.939453 1.11063.442475 2.11782 1.117109 2.96875 1.955078 1.69271-1.222252 3.38676-2.442646 5.08008-3.664062-2.66632-2.652709-6.35737-4.016762-10.05096-4.376845-.67268-.08546-1.35003-.09118-2.02717-.07433z"/><path id="path460" style="fill:#000;stroke-width:.204716" d="m286.07422 99.496094c-1.07934-.0024-1.82247.939246-2.52539 1.519526-.851.70779-1.76177 1.34363-2.75 1.84571.10409 1.4247 1.00637 2.71545 2.30403 3.3049 1.0993.9205 2.58927 1.76482 4.04753 1.17752 1.90839-.57603 3.60529-2.60159 3.03127-4.66604-.24239-1.55382-1.36304-3.209315-3.09377-3.187476-.33817.0088-.67622-.02649-1.01367.0059z"/><path id="path464" style="fill:#000;stroke-width:.204716" d="m371.67188 20.626953c-3.87604 1.944717-7.75613 3.888659-11.47852 6.119141 1.10416-.0044 2.20833-.0089 3.3125-.01172-2.12786 4.917471-2.2546 10.388689-2.12305 15.660156.35129 5.01355 2.02586 9.810998 3.70363 14.509646 1.38866 3.777132 2.7827 7.452227 3.66164 11.3659.85336 3.402855 1.29928 6.910206 1.308 10.447135.0802 4.183874.21652 8.436832-.61619 12.533292-.82952 4.256594-2.10342 8.496467-4.44794 12.181686-1.27591 2.17814-2.95847 4.09056-4.92893 5.66614-1.4947 1.30394-3.28466 2.42294-5.1431 2.96612-2.39632.75818-4.8139.92992-7.31504.96576-1.38398-.001-2.76732-.6657-3.42811-1.91942-1.17952-1.92247-1.43828-4.29667-1.23452-6.50088-.072-.59683.49407-.45599.8906-.49906.4488-.0105 1.13089-.11797 1.17301.51024.41153 1.70485.26658 3.48863.31896 5.23047 71e-5.68229.002 1.36459.003 2.04688 1.90405-1.12478 3.80883-2.24831 5.7129-3.37305-.13258-2.7825.25622-5.8613-1.42774-8.28125-.9124-1.199373-2.54906-1.368673-3.94062-1.215946-1.58257-.05091-3.231.243516-4.50269 1.241586-2.01363 1.04845-3.69566 2.97113-3.89001 5.30511-.35901 2.56593.15031 5.20715 1.10217 7.59326 1.08182 2.48207 3.33319 4.66552 6.14699 4.84641 2.41571.25391 4.83773-.17138 7.23065-.45987 3.43975-.6249 6.46732-2.49346 9.27287-4.49033 3.70335-2.48113 7.17849-5.51773 9.32948-9.48525 2.76734-4.614072 4.23626-9.901741 4.96799-15.199902.5525-4.277499.36306-8.601147.27024-12.900272-.10538-3.360412-.59916-6.701988-1.5034-9.941147-1.01323-4.310005-2.61015-8.445066-4.11035-12.599558-1.15953-3.383432-2.2477-6.765931-2.76717-10.283458-.33024-3.191741-.23107-6.55122.089-9.779123.36915-3.275313 1.43804-6.518457 3.45986-9.153927.90985-1.339577 1.8197-2.679149 2.72974-4.018598-.60873.307943-1.21745.615885-1.82617.923828z"/><path id="path466" style="fill:#000;stroke-width:.204716" d="m378.41211 36.992188c-2.95498.280324-5.86099.959554-8.72191 1.726685-3.48706 1.125695-6.68165 3.068917-9.47059 5.423031-2.56647 2.52845-3.92486 5.941757-5.55982 9.083275-.82608 1.721803-1.65239 3.443491-2.47815 5.165446 2.4334-1.275762 4.86732-2.550527 7.30078-3.826172 1.48474-3.078592 2.82421-6.267576 5.04492-8.919922.37009-.484192 1.06101-.352533 1.4769-.805542.96403-.824462 2.26732-1.015047 3.43718-1.415431 2.16001-.556031 4.36494-1.020535 6.56444-1.321996 1.63608-.05267 2.81813 1.277896 3.61272 2.548816 1.61011 2.517063 2.53967 5.509476 2.17683 8.471365-.15926.806383-.30463 1.757669-.91027 2.335911-1.23529.812349-2.5271 1.570455-3.64881 2.53258-1.05465 1.010852-1.29014 2.99378.005 3.90959 1.10397.771221 2.48005.146732 3.46359-.520192 1.29018-.710688 2.43727-1.673469 3.63473-2.496494 3.70686-.791836 7.53625-.861897 11.30656-.662435 1.77784.291901 3.18039 1.611104 4.02392 3.142913 2.57898 3.825958 4.24413 8.148004 4.98248 12.705642.67022 3.616411 1.12179 7.379282.74216 11.014872-.34106 1.748258-.84725 3.691605-1.96926 5.175636-.96893.649595-2.1745.835524-3.28802 1.122337-2.6009.548228-5.39227.396336-7.7976-.803806-2.77349-1.192048-5.22531-3.0329-7.28016-5.233016-.3945-.779099-.90346-.07995-1.38135.226711-1.35242.977451-2.70594 1.953363-4.05756 2.931914 2.24054 2.398724 4.74359 4.601413 7.68825 6.093768 3.25183 1.841965 7.13161 2.665009 10.82624 1.922007 3.6294-.612513 7.11555-2.286566 9.77115-4.844758 1.96335-2.122487 2.68295-5.045637 3.19814-7.807952.3987-5.091629-.44666-10.18885-1.56074-15.141305-1.05935-4.233613-3.02767-8.207304-5.51137-11.780005-1.25317-1.797572-3.09833-3.242237-5.29091-3.639442-2.34828-.50242-4.76173-.155362-7.13833-.149969-1.48293.0791-2.96525.208398-4.43164.447266 1.1072-4.302368-.25828-8.87208-2.60303-12.520248-1.37932-2.074659-3.51292-4.084833-6.15674-4.09108z"/><path id="path468" style="fill:#000;stroke-width:.204716" d="m423.28906 62.134766c-1.63995.97054-3.28033 1.94036-4.92187 2.908203-.005 4.860224-.0554 9.74159.63518 14.564078.26451 3.642161-.0516 7.367269.98576 10.916826.42202 1.528949.57544 3.428854 2.02945 4.374565 1.67804 1.119853 3.85376.452608 5.42395-.533389 2.15482-1.410381 4.32474-2.885565 5.95208-4.915798 1.06489-1.237277 1.93975-2.619085 2.8603-3.962923-2.69521.780684-5.50568 1.495949-7.83152 3.126296-.73545.615066-1.29977 1.758673-2.3345 1.799485-.65265-2.346208-1.1458-4.764948-1.22309-7.213103-.001-3.183751-.28693-6.355244-.63761-9.516081-.28356-3.960842-.13171-8.020399-.13344-12.024722-.26823.158854-.53646.317708-.80469.476563z"/><path id="path470" style="fill:#000;stroke-width:.204716" d="m421.32422 50.556641c-1.07185.409354-1.82089 1.344889-2.78081 1.947169-.73001.555316-1.46029 1.110263-2.18989 1.666112 1.19469.615669 2.29216 1.471247 3.61328 1.802734-.0189 1.007812-.038 2.015621-.0566 3.023438 1.91341-1.124993 3.82781-2.248329 5.74023-3.375.0396-1.199558-.0142-2.413731.24219-3.587891-.0222-1.061754-1.27193-1.818341-2.21354-1.303916-.4361.07207-.95475.446837-1.31358.0097-.30768-.168724-.69727-.282971-1.04124-.182359z"/><path id="path474" style="fill:#000;stroke-width:.204716" d="m478.08398 8.6914062c-3.04434.14731-5.7197 1.8438508-8.10248 3.6007978-1.72765 1.357081-2.97442 3.250966-3.63815 5.337598-2.26887 6.050536-2.21342 12.612826-2.40727 18.981009-.15743 8.550261.61576 17.100356 1.57762 25.572923.191 1.852456.35825 3.707256.52146 5.56236-2.14353 4.328099-4.51967 8.591659-7.70401 12.250805-2.36409 2.930614-4.6741 5.893283-7.25693 8.60857-1.23948.310478-2.55965.07497-3.80664-.115235-2.07257-.364678-3.86782-1.59835-5.23261-3.16249-1.81027-2.033779-3.15103-4.509976-3.85346-7.138711-.58177-3.373649.71016-6.7518 2.34552-9.649041.48255-.732833.88067-1.621841 1.6468-2.092726 2.34007-.143427 4.64989.535834 6.77539 1.46875.99634-.283035 1.63883-1.177063 2.49285-1.713624.99586-.778422 1.99114-1.557572 2.98762-2.335204-3.46085-1.340304-7.09892-2.967477-10.89987-2.427405-2.11783.508015-3.79571 2.000439-5.52392 3.235425-2.68145 2.341808-4.00679 5.78142-5.09379 9.076745-.89502 3.13538-.75704 6.605691.71513 9.548105 1.7092 3.847785 4.41928 7.489981 8.28686 9.356697 2.33088 1.021718 4.95868 1.325034 7.47457 1.052229 2.3056-.511534 4.29585-1.953137 6.00586-3.52539 2.54674-2.587205 4.77423-5.461403 7.04935-8.278252 1.52223-1.934278 3.11838-3.823289 4.42135-5.917061.59397 4.795158.8271 9.581025.6875 14.417969.0867 1.188555-.17941 2.681701.89258 3.509766.8519.734443 2.1919.630446 2.95133-.187286.77818-.629943 1.39784-1.430245 2.18539-2.050996.33463-4.101681.12961-8.221072.17483-12.330182-.0958-2.588148-.18458-5.17999-.3428-7.763568-.3245-1.63234-.58546-3.442123.28436-4.958718.51754-.816296 1.63351-.855617 2.47541-1.136985 1.29347-.223993 2.66956-.428758 3.95583-.11448 1.70322.767865 2.36308 2.681045 3.25511 4.18284 2.45359 5.01299 2.5034 10.662947 3.45117 16.066406.39453 1.998924.93975 4.059017 2.15761 5.723926 1.20516 1.352908 3.27678 1.341194 4.82481.637402 4.38174-1.593728 8.19236-4.35232 12.07422-6.859375 1.31644-.900078 2.96011-1.738505 3.51562-3.339844.18957-1.049313-1.14649-1.612884-1.96679-1.169922-.35611.233689-.66171.381595-1.10399.363009-2.26559.572321-3.99719 2.262336-6.02241 3.343699-2.07882 1.256166-4.16238 2.484729-6.55915 3.076496-.54459-.626324-.63649-1.53044-.94141-2.28711-.9522-3.598937-.99491-7.326699-1.76776-10.965895-.59128-3.450187-1.70586-6.83908-3.59788-9.802482-1.17173-2.100903-3.12486-4.124232-5.67959-4.213301-1.78692-.04961-3.60589.110612-5.3292.60205-.7058.211269-1.39123.486775-2.05525.805409 3.21714-7.057532 5.53801-14.470846 8.14459-21.764942 1.39013-3.996916 2.6535-8.095743 2.86422-12.350426.27986-3.961867.2851-7.946035.11578-11.911498-.22997-2.048169-.57126-4.334547-2.12459-5.8286024-1.48757-1.1781658-3.52717-.9718637-5.30079-.9902344zm-1.34765 5.0468748c.75756.100169 1.59662-.102993 2.29883.236328 1.20912 2.467702.83156 5.298741.93641 7.954687.0175 5.110463-.15302 10.311699-1.90356 15.185035-2.1116 6.637828-4.48624 13.179085-6.98769 19.684909-.22521.70112-.41136 1.033956-.41626.0992-.7906-7.151956-1.36504-14.321603-1.13549-21.539947.1018-5.837394.16128-11.671654 2.02378-17.234781.55964-1.515727 1.23048-3.250281 2.74843-4.035819.79358-.213639 1.61188-.339885 2.43555-.34961zm-4.6543 76.720703c.62866.420068-.45727 1.13443-.58012.305527-.23418-.244089.43497-.422407.58012-.305527z"/><path id="path476" style="fill:#000;stroke-width:.204716" d="m444.84375 25.214844c-1.64773.385233-3.25602 1.067363-4.67561 1.987852-2.04086 1.6493-3.49412 3.884237-5.29746 5.771289-2.66063 2.970824-5.68987 5.575842-8.77289 8.092454-.58007.602259-1.39502 1.328599-1.25795 2.242155.25323.910636 1.38471.929547 2.11011.630268 1.39615-.334178 2.69141-1.03155 3.91085-1.761623 4.12198-3.246933 7.92443-6.902681 11.24802-10.966954 1.09459-1.394037 2.48316-2.522459 3.55811-3.926379.59161-.629078.42113-1.908335-.5224-2.035859-.10001-.0081-.19903-.06601-.30078-.0332z"/><path id="path510" style="fill:#000;stroke:#000;stroke-width:.0832446" d="m156.66797 65.568359c-1.40281.04819-2.00876 2.164215-.79102 2.908203 1.10643.978518 2.94358-.355474 2.51367-1.714843-.18241-.751321-.9599-1.271376-1.72265-1.19336z"/><path id="path512" style="fill:#000;stroke:#000;stroke-width:.0832446" d="m156.66797 65.568359c-1.40281.04819-2.00876 2.164215-.79102 2.908203 1.10643.978518 2.94358-.355474 2.51367-1.714843-.18241-.751321-.9599-1.271376-1.72265-1.19336z"/><path id="path1432" style="fill:#000;stroke-width:.202157" d="m94.878906 30.269531c-2.287631.898028-4.703901 1.605195-6.807724 2.877579-4.485024 5.491989-6.611133 12.401509-8.442948 19.132856-1.605329 6.046121-2.840557 12.204453-4.985613 18.095796-2.771657 8.014773-6.035967 15.844748-10.868943 22.859542-1.749947 2.479612-3.601343 4.885482-5.392819 7.335006 2.85849-1.26468 5.716446-2.530574 8.574219-3.796872 6.610002-8.720957 10.691919-19.019319 14.096589-29.330787 2.790753-8.7136 4.127071-17.89265 7.79901-26.319883 1.235636-2.821633 2.900303-5.441874 4.898209-7.783699.952846-1.237371 1.905694-2.474742 2.858536-3.712116-.576172.214193-1.152344.428386-1.728516.642578z"/><path id="path1434" style="fill:#000;stroke-width:.202157" d="m93.257812 30.740234c-1.733368.858571-3.440196 1.845878-5.164062 2.751954.810252 5.34993 3.024219 10.347909 4.425405 15.521466 2.072478 6.784453 3.847313 13.681516 5.505429 20.598588 1.180239 4.908903 1.729165 9.94751 2.987136 14.836977.96649 3.670046 2.49394 7.275685 4.9564 10.198384.78807.844102 1.64803 1.682248 2.67836 2.213725.88334.191728 1.43837-.72189 2.17288-1.03501 1.14091-.744883 2.2825-1.48873 3.42283-2.234521-1.77857-1.19183-3.63718-2.460542-4.64263-4.417814-3.0829-4.597975-3.70366-10.234336-4.77902-15.52966-.8585-4.588927-2.03141-9.108024-3.16222-13.634617-.51284-2.223885-1.15403-4.419896-1.735477-6.627752-1.569505-5.662739-3.34325-11.323358-5.050111-16.90562-.517229-1.710922-.87143-3.482123-.92156-5.26735-.0439-.278108-.408679-.604452-.69336-.46875zm7.623048 27.275391c-.2376.743408-1.454441-.29859-.48492-.165475.15225.06679.66504-.188859.48492.165475z"/><path id="path1440" style="fill:#000;stroke-width:.202157" d="m93.693359 58.945312c-4.070097.13705-8.123695.652337-12.201562.568416-3.492748.01042-6.98542-.0175-10.478125-.02935-2.241288 1.678066-4.483664 3.354679-6.72461 5.033203 6.767011-.175815 13.540661.04814 20.304958-.196194 5.878883-.507678 11.806803-.677339 17.69857-.02042 1.78153.149956 3.55694.456984 5.32078.675666 1.05621-.117502 1.71027-1.096398 2.59049-1.591397 1.38565-1.016663 2.77006-2.035027 4.15747-3.049296-3.12468-.07048-6.17775-.620639-9.27187-.956016-3.16628-.218965-6.328998-.549518-9.507395-.458409-.629656-.01131-1.259141.01642-1.888706.0238z"/><path id="path1442" style="fill:#000;stroke-width:.202157" d="m137.80273 32.195312c-.71131-.02645-1.22365.533659-1.76757.896485-3.32296-.648355-6.5358.949258-9.31521 2.591857-4.13708 2.423361-8.39589 5.160194-10.8685 9.405801-2.81817 4.65217-3.70379 10.122397-4.38312 15.431557-.71678 4.62043-.63171 9.312129-.6621 13.974246-.17073 3.941542 1.22301 7.714025 2.78316 11.263402 1.47756 3.374971 2.98687 6.93403 5.78974 9.440876 2.60206 2.103977 5.98229 2.938743 9.26997 3.079382 3.01616.178255 6.04839.197489 9.0654.05924 3.25526-.352297 6.13656-2.210964 8.52083-4.353872 1.9125-1.802379 3.23536-4.122029 4.467-6.415823 1.96654-3.819715 2.97141-8.06343 3.32178-12.327816.63197-6.298061.53467-12.640058.51157-18.961602-.31286-6.555578-3.34059-12.6311-7.00772-17.94516-1.36398-2.116257-3.08084-4.117768-5.41961-5.176398-1.33498-.643965-2.82253-.990471-4.30562-.962179zm.92969 5.699219c2.47608 1.49523 3.89223 4.131017 5.42803 6.481762 2.3619 3.875065 4.21223 8.273459 4.57393 12.778004.10946 3.540014.0754 7.199129.0226 10.786117-.13267 4.59801-.30727 9.207498-1.382 13.719742-.93846 3.818379-2.73823 7.354917-5.25828 10.371228-.54974.799923-1.41776 1.322856-2.39992 1.343616-2.75225.198886-5.52039.102639-8.2763.011-2.77568-.07296-5.73025-.633233-7.86708-2.529377-2.10928-2.179327-3.28872-5.047642-4.51317-7.774861-1.11282-2.692425-2.33357-5.39614-2.44851-8.361666-.14085-3.190521-.0674-6.390597.0562-9.581427.14975-3.270265.65943-6.610104 1.17386-9.878406.69163-3.869378 1.85813-7.786775 4.2574-10.998784 1.95471-2.475077 4.54847-4.446958 7.40796-5.758508 1.93693-.843915 4.24175-.844849 6.06259.206969.44889.199604.90067.715415 1.31312.18647.57632-.317847 1.12482-.8901 1.71804-1.053332l.0931.03644z"/><path id="path2471" style="fill:#000;stroke-width:.202157" d="m19.875-1.1464844c-2.467326.20038379-4.416995 1.8977635-6.465485 3.1000412-2.092157 1.6351412-3.347691 4.0900298-4.3407045 6.4976497-1.162515 3.0913185-1.9649042 6.3534035-2.1332636 9.6581685-.020817 3.848753 1.14656 7.564265 2.0214843 11.275391.9423091 3.535474 1.9990858 7.038851 3.0273438 10.550781-3.558475 2.085762-7.2987095 4.432847-9.2179466 8.23808-1.91058832 3.644811-3.22225643 7.686999-3.32760678 11.823119.0280441 1.872592 1.03030634 3.785445 2.80262948 4.546582 2.8585542 1.517064 6.1649538 1.732272 9.3167369 2.130179 2.211118.216219 4.432631.329845 6.654703.314774.344948 5.553728.702102 11.179714-.130052 16.708708-.113818.436681-.01061 1.276409-.671293.840427-3.346086-.889374-7.010389-.937983-10.2533429.368834-1.4220886.706309-2.8423797 1.439918-4.1587002 2.330061-1.4833855 1.011485-2.50642305 2.816075-2.15738584 4.639764.27670544 1.50483.83204454 2.946746 1.31812824 4.392702 1.0029707 2.447538 2.6634652 4.859863 5.174811 5.915053 1.664462.60635 3.4565307-.0423 4.8542497-.98599 2.199044-1.234 4.187541-2.882528 5.579001-5.004834 1.075465-1.478272 2.02244-3.044267 2.962162-4.610975 3.73972 1.912958 7.639363 3.750579 11.866027 4.220964 5.229014.819247 10.534141 1.238137 15.827896 1.103707 4.609822-.188519 9.320543-1.100025 13.28447-3.57145 2.628989-1.435801 5.127933-3.288571 6.707934-5.886007 2.551407-3.93756 3.549201-8.680994 3.793283-13.30966.08651-4.065033-.232752-8.209911-1.679065-12.044616-1.683663-4.622633-4.346852-8.915431-7.956449-12.282379-4.78356-4.628438-10.902243-7.535639-17.076681-9.825795-7.576235-2.890711-15.799324-3.887274-23.870477-3.415234-1.45148.184805-2.908547.38467-4.31686.793673-1.772122-6.15093-3.742629-12.328265-4.585432-18.662232-.243926-3.049717.472069-6.06426 1.365298-8.9933226.743461-2.0621443 1.62728-4.2323716 3.323377-5.6960226.804625-.5857958 1.775496.026879 2.575239.3129153.608663.2214678 1.178371.9384883.681754 1.546329-.687235 1.1336659-1.997566 1.6924602-2.676648 2.8375411-.420302.6993466-1.297068 1.3490728-.984369 2.2680738.448857.947951 1.697752.638275 2.485067.36589 1.793577-.782484 3.519119-1.7891435 5.009073-3.0651091 1.372296-1.2711291 2.618085-3.140637 2.133059-5.0953206-.549199-2.41423932-3.002514-3.84881267-5.297121-4.2288982-.484264-.078-.974257-.1160508-1.464844-.1015625zm2.066406 42.4824224c5.853967-.03158 11.785551.546324 17.387283 2.30404 4.052566 1.30083 8.026984 2.903842 11.762369 4.951333 5.171419 2.854776 9.830438 7.20005 12.475348 12.525877 1.234364 2.513606 2.149442 5.042218 2.600007 7.830174.348285 2.619998.47256 5.234756.24345 7.882353-.425086 3.919758-1.452478 7.980039-4.029004 11.066769-.637384.750619-1.422851 1.348609-2.123047 2.027344-3.417276 1.602835-7.25638 2.104568-11.001905 2.182687-4.985171.02644-9.943714-.403025-14.861623-1.232555-3.16245-.549877-6.092862-1.904429-8.944116-3.320687-.838298-.398379-1.679269-.793986-2.540012-1.141164 1.812739-5.97312 1.288897-12.293939 1.067125-18.439473.08478-.454615-.401074-1.38791.322921-1.299128 3.346957-.366107 6.725447-.875339 9.86123-2.155826 2.572518-.853242 5.295532-1.091423 7.965567-1.478959.642141-.03087 1.250964-.146033 1.697525-.648911 2.229063-1.713274 4.457918-3.426817 6.687195-5.139812-4.945597.703564-9.950537 1.113255-14.814788 2.283884-1.61454.601637-3.200266 1.331198-4.929937 1.532373-2.392654.476772-4.818149.835899-7.265041.964993-.635149-6.333213-1.951949-12.621946-4.230469-18.576172-.181271-.560347-.446635-1.227831-.632812-1.841797 1.092247-.174855 2.197184-.257762 3.302734-.277343zm-8.710937 2.630859c1.73383 4.920162 3.416007 9.901736 4.097298 15.096077.154901 1.011684.293383 2.025855.410514 3.042595-3.639733-.157396-7.270674-.462804-10.7617185-1.548828-.916187-.285016-1.9318113-.99391-1.7441406-2.091797.067658-2.619841.815338-5.182345 1.7460937-7.615235 1.0452584-2.582819 2.7582053-5.072404 5.2017964-6.593561.355667-.148591.965967-1.118661 1.0366-.331886zM11.498047 88.84375c1.581425.113622 3.132072.488669 4.638672.970703-1.320122 2.612878-3.004131 5.040366-4.855469 7.300781-.497488.672024-1.249391-.0561-1.6745127-.424631-1.8941345-1.83007-2.544719-4.510543-3.0598623-6.995291.5756926-.538238 1.4988482-.576207 2.2554181-.731905.8912275-.117794 1.7976289-.18021 2.6957539-.119657z"/></svg>
</a>
</div><div class=searchbox>
<label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span>
</div><script type=text/javascript src=/js/lunr.min.js?1646795377></script>
<script type=text/javascript src=/js/auto-complete.js?1646795377></script>
<script type=text/javascript>var baseurl="https://artisanbox.github.io"</script>
<script type=text/javascript src=/js/search.js?1646795377></script>
</div><section id=homelinks>
<ul>
<li>
<a class=padding href=/><i class="fas fa-home"></i> Gen 的学习笔记</a>
</li></ul></section><div class=highlightable>
<ul class=topics>
<li data-nav-id=/1/ title=MySQL实战45讲 class="dd-item
parent">
<a href=/1/>
MySQL实战45讲
</a>
<ul>
<li data-nav-id=/1/1/ title=01_基础架构：一条SQL查询语句是如何执行的？ class=dd-item>
<a href=/1/1/>
01_基础架构：一条SQL查询语句是如何执行的？
</a>
</li><li data-nav-id=/1/2/ title=02_日志系统：一条SQL更新语句是如何执行的？ class=dd-item>
<a href=/1/2/>
02_日志系统：一条SQL更新语句是如何执行的？
</a>
</li><li data-nav-id=/1/3/ title=03_事务隔离：为什么你改了我还看不见？ class=dd-item>
<a href=/1/3/>
03_事务隔离：为什么你改了我还看不见？
</a>
</li><li data-nav-id=/1/4/ title=04_深入浅出索引（上） class=dd-item>
<a href=/1/4/>
04_深入浅出索引（上）
</a>
</li><li data-nav-id=/1/5/ title=05_深入浅出索引（下） class=dd-item>
<a href=/1/5/>
05_深入浅出索引（下）
</a>
</li><li data-nav-id=/1/6/ title=06_全局锁和表锁：给表加个字段怎么有这么多阻碍？ class=dd-item>
<a href=/1/6/>
06_全局锁和表锁：给表加个字段怎么有这么多阻碍？
</a>
</li><li data-nav-id=/1/7/ title=07_行锁功过：怎么减少行锁对性能的影响？ class=dd-item>
<a href=/1/7/>
07_行锁功过：怎么减少行锁对性能的影响？
</a>
</li><li data-nav-id=/1/8/ title=08_事务到底是隔离的还是不隔离的？ class=dd-item>
<a href=/1/8/>
08_事务到底是隔离的还是不隔离的？
</a>
</li><li data-nav-id=/1/9/ title=09_普通索引和唯一索引，应该怎么选择？ class=dd-item>
<a href=/1/9/>
09_普通索引和唯一索引，应该怎么选择？
</a>
</li><li data-nav-id=/1/10/ title=10_MySQL为什么有时候会选错索引？ class=dd-item>
<a href=/1/10/>
10_MySQL为什么有时候会选错索引？
</a>
</li><li data-nav-id=/1/11/ title=11_怎么给字符串字段加索引？ class=dd-item>
<a href=/1/11/>
11_怎么给字符串字段加索引？
</a>
</li><li data-nav-id=/1/12/ title=12_为什么我的MySQL会“抖”一下？ class=dd-item>
<a href=/1/12/>
12_为什么我的MySQL会“抖”一下？
</a>
</li><li data-nav-id=/1/13/ title=13_为什么表数据删掉一半，表文件大小不变？ class=dd-item>
<a href=/1/13/>
13_为什么表数据删掉一半，表文件大小不变？
</a>
</li><li data-nav-id=/1/14/ title=14_count(x)这么慢，我该怎么办？ class=dd-item>
<a href=/1/14/>
14_count(x)这么慢，我该怎么办？
</a>
</li><li data-nav-id=/1/15/ title=15_答疑文章（一）：日志和索引相关问题 class=dd-item>
<a href=/1/15/>
15_答疑文章（一）：日志和索引相关问题
</a>
</li><li data-nav-id=/1/16/ title=16_“orderby”是怎么工作的？ class=dd-item>
<a href=/1/16/>
16_“orderby”是怎么工作的？
</a>
</li><li data-nav-id=/1/17/ title=17_如何正确地显示随机消息？ class=dd-item>
<a href=/1/17/>
17_如何正确地显示随机消息？
</a>
</li><li data-nav-id=/1/18/ title=18_为什么这些SQL语句逻辑相同，性能却差异巨大？ class=dd-item>
<a href=/1/18/>
18_为什么这些SQL语句逻辑相同，性能却差异巨大？
</a>
</li><li data-nav-id=/1/19/ title=19_为什么我只查一行的语句，也执行这么慢？ class=dd-item>
<a href=/1/19/>
19_为什么我只查一行的语句，也执行这么慢？
</a>
</li><li data-nav-id=/1/20/ title=20_幻读是什么，幻读有什么问题？ class=dd-item>
<a href=/1/20/>
20_幻读是什么，幻读有什么问题？
</a>
</li><li data-nav-id=/1/21/ title=21_为什么我只改一行的语句，锁这么多？ class=dd-item>
<a href=/1/21/>
21_为什么我只改一行的语句，锁这么多？
</a>
</li><li data-nav-id=/1/22/ title=22_MySQL有哪些“饮鸩止渴”提高性能的方法？ class=dd-item>
<a href=/1/22/>
22_MySQL有哪些“饮鸩止渴”提高性能的方法？
</a>
</li><li data-nav-id=/1/23/ title=23_MySQL是怎么保证数据不丢的？ class=dd-item>
<a href=/1/23/>
23_MySQL是怎么保证数据不丢的？
</a>
</li><li data-nav-id=/1/24/ title=24_MySQL是怎么保证主备一致的？ class=dd-item>
<a href=/1/24/>
24_MySQL是怎么保证主备一致的？
</a>
</li><li data-nav-id=/1/25/ title=25_MySQL是怎么保证高可用的？ class=dd-item>
<a href=/1/25/>
25_MySQL是怎么保证高可用的？
</a>
</li><li data-nav-id=/1/26/ title=26_备库为什么会延迟好几个小时？ class=dd-item>
<a href=/1/26/>
26_备库为什么会延迟好几个小时？
</a>
</li><li data-nav-id=/1/27/ title=27_主库出问题了，从库怎么办？ class=dd-item>
<a href=/1/27/>
27_主库出问题了，从库怎么办？
</a>
</li><li data-nav-id=/1/28/ title=28_读写分离有哪些坑？ class="dd-item active">
<a href=/1/28/>
28_读写分离有哪些坑？
</a>
</li><li data-nav-id=/1/29/ title=29_如何判断一个数据库是不是出问题了？ class=dd-item>
<a href=/1/29/>
29_如何判断一个数据库是不是出问题了？
</a>
</li><li data-nav-id=/1/30/ title=30_答疑文章（二）：用动态的观点看加锁 class=dd-item>
<a href=/1/30/>
30_答疑文章（二）：用动态的观点看加锁
</a>
</li><li data-nav-id=/1/31/ title=31_误删数据后除了跑路，还能怎么办？ class=dd-item>
<a href=/1/31/>
31_误删数据后除了跑路，还能怎么办？
</a>
</li><li data-nav-id=/1/32/ title=32_为什么还有kill不掉的语句？ class=dd-item>
<a href=/1/32/>
32_为什么还有kill不掉的语句？
</a>
</li><li data-nav-id=/1/33/ title=33_我查这么多数据，会不会把数据库内存打爆？ class=dd-item>
<a href=/1/33/>
33_我查这么多数据，会不会把数据库内存打爆？
</a>
</li><li data-nav-id=/1/34/ title=34_到底可不可以使用join？ class=dd-item>
<a href=/1/34/>
34_到底可不可以使用join？
</a>
</li><li data-nav-id=/1/35/ title=35_join语句怎么优化？ class=dd-item>
<a href=/1/35/>
35_join语句怎么优化？
</a>
</li><li data-nav-id=/1/36/ title=36_为什么临时表可以重名？ class=dd-item>
<a href=/1/36/>
36_为什么临时表可以重名？
</a>
</li><li data-nav-id=/1/37/ title=37_什么时候会使用内部临时表？ class=dd-item>
<a href=/1/37/>
37_什么时候会使用内部临时表？
</a>
</li><li data-nav-id=/1/38/ title=38_都说InnoDB好，那还要不要使用Memory引擎？ class=dd-item>
<a href=/1/38/>
38_都说InnoDB好，那还要不要使用Memory引擎？
</a>
</li><li data-nav-id=/1/39/ title=39_自增主键为什么不是连续的？ class=dd-item>
<a href=/1/39/>
39_自增主键为什么不是连续的？
</a>
</li><li data-nav-id=/1/40/ title=40_insert语句的锁为什么这么多？ class=dd-item>
<a href=/1/40/>
40_insert语句的锁为什么这么多？
</a>
</li><li data-nav-id=/1/41/ title=41_怎么最快地复制一张表？ class=dd-item>
<a href=/1/41/>
41_怎么最快地复制一张表？
</a>
</li><li data-nav-id=/1/42/ title=42_grant之后要跟着flushprivileges吗？ class=dd-item>
<a href=/1/42/>
42_grant之后要跟着flushprivileges吗？
</a>
</li><li data-nav-id=/1/43/ title=43_要不要使用分区表？ class=dd-item>
<a href=/1/43/>
43_要不要使用分区表？
</a>
</li><li data-nav-id=/1/44/ title=44_答疑文章（三）：说一说这些好问题 class=dd-item>
<a href=/1/44/>
44_答疑文章（三）：说一说这些好问题
</a>
</li><li data-nav-id=/1/45/ title=45_自增id用完怎么办？ class=dd-item>
<a href=/1/45/>
45_自增id用完怎么办？
</a>
</li><li data-nav-id=/1/47/ title=开篇词_这一次，让我们一起来搞懂MySQL class=dd-item>
<a href=/1/47/>
开篇词_这一次，让我们一起来搞懂MySQL
</a>
</li><li data-nav-id=/1/48/ title=直播回顾_林晓斌：我的MySQL心路历程 class=dd-item>
<a href=/1/48/>
直播回顾_林晓斌：我的MySQL心路历程
</a>
</li><li data-nav-id=/1/46/ title=结束语_点线网面，一起构建MySQL知识网络 class=dd-item>
<a href=/1/46/>
结束语_点线网面，一起构建MySQL知识网络
</a>
</li><li data-nav-id=/1/49/ title=结课测试｜这些MySQL知识你都掌握了吗？ class=dd-item>
<a href=/1/49/>
结课测试｜这些MySQL知识你都掌握了吗？
</a>
</li></ul></li></ul><section id=footer>
<p>Built with <a href=https://github.com/matcornic/hugo-theme-learn><i class="fas fa-heart"></i></a> from <a href=https://getgrav.org>Grav</a> and <a href=https://gohugo.io/>Hugo</a></p></section></div></nav><section id=body>
<div id=overlay></div><div class="padding highlightable">
<div>
<div id=top-bar>
<div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb>
<span id=sidebar-toggle-span>
<a href=# id=sidebar-toggle data-sidebar-toggle>
<i class="fas fa-bars"></i>
</a>
</span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>
<a href=/>Gen 的学习笔记</a> > <a href=/1/>MySQL实战45讲</a> > 28_读写分离有哪些坑？
</span>
</div><div class=progress>
<div class=wrapper>
<nav id=TableOfContents></nav></div></div></div></div><div id=head-tags>
</div><div id=body-inner>
<h1>
28_读写分离有哪些坑？
</h1><p><audio title="28 _ 读写分离有哪些坑？" src=https://static001.geekbang.org/resource/audio/ce/40/ce9c998b0e6524551244696dca1d1240.mp3 controls></audio></p><p>在上一篇文章中，我和你介绍了一主多从的结构以及切换流程。今天我们就继续聊聊一主多从架构的应用场景：读写分离，以及怎么处理主备延迟导致的读写分离问题。</p><p>我们在上一篇文章中提到的一主多从的结构，其实就是读写分离的基本结构了。这里，我再把这张图贴过来，方便你理解。</p><p><img src=https://static001.geekbang.org/resource/image/13/aa/1334b9c08b8fd837832fdb2d82e6b0aa.png alt></p><center><span class=reference>图1 读写分离基本结构</span></center><p>读写分离的主要目标就是分摊主库的压力。图1中的结构是客户端（client）主动做负载均衡，这种模式下一般会把数据库的连接信息放在客户端的连接层。也就是说，由客户端来选择后端数据库进行查询。</p><p>还有一种架构是，在MySQL和客户端之间有一个中间代理层proxy，客户端只连接proxy， 由proxy根据请求类型和上下文决定请求的分发路由。</p><p><img src=https://static001.geekbang.org/resource/image/1b/45/1b1ea74a48e1a16409e9b4d02172b945.jpg alt></p><center><span class=reference>图2 带proxy的读写分离架构</span></center><p>接下来，我们就看一下客户端直连和带proxy的读写分离架构，各有哪些特点。</p><ol>
<li>
<p>客户端直连方案，因为少了一层proxy转发，所以查询性能稍微好一点儿，并且整体架构简单，排查问题更方便。但是这种方案，由于要了解后端部署细节，所以在出现主备切换、库迁移等操作的时候，客户端都会感知到，并且需要调整数据库连接信息。<br>
你可能会觉得这样客户端也太麻烦了，信息大量冗余，架构很丑。其实也未必，一般采用这样的架构，一定会伴随一个负责管理后端的组件，比如Zookeeper，尽量让业务端只专注于业务逻辑开发。</p></li><li>
<p>带proxy的架构，对客户端比较友好。客户端不需要关注后端细节，连接维护、后端信息维护等工作，都是由proxy完成的。但这样的话，对后端维护团队的要求会更高。而且，proxy也需要有高可用架构。因此，带proxy架构的整体就相对比较复杂。</p></li></ol><p>理解了这两种方案的优劣，具体选择哪个方案就取决于数据库团队提供的能力了。但目前看，趋势是往带proxy的架构方向发展的。</p><p>但是，不论使用哪种架构，你都会碰到我们今天要讨论的问题：由于主从可能存在延迟，客户端执行完一个更新事务后马上发起查询，如果查询选择的是从库的话，就有可能读到刚刚的事务更新之前的状态。</p><p><strong>这种“在从库上会读到系统的一个过期状态”的现象，在这篇文章里，我们暂且称之为“过期读”。</strong></p><p>前面我们说过了几种可能导致主备延迟的原因，以及对应的优化策略，但是主从延迟还是不能100%避免的。</p><p>不论哪种结构，客户端都希望查询从库的数据结果，跟查主库的数据结果是一样的。</p><p>接下来，我们就来讨论怎么处理过期读问题。</p><p>这里，我先把文章中涉及到的处理过期读的方案汇总在这里，以帮助你更好地理解和掌握全文的知识脉络。这些方案包括：</p><ul>
<li>强制走主库方案；</li><li>sleep方案；</li><li>判断主备无延迟方案；</li><li>配合semi-sync方案；</li><li>等主库位点方案；</li><li>等GTID方案。</li></ul><h1>强制走主库方案</h1><p>强制走主库方案其实就是，将查询请求做分类。通常情况下，我们可以将查询请求分为这么两类：</p><ol>
<li>
<p>对于必须要拿到最新结果的请求，强制将其发到主库上。比如，在一个交易平台上，卖家发布商品以后，马上要返回主页面，看商品是否发布成功。那么，这个请求需要拿到最新的结果，就必须走主库。</p></li><li>
<p>对于可以读到旧数据的请求，才将其发到从库上。在这个交易平台上，买家来逛商铺页面，就算晚几秒看到最新发布的商品，也是可以接受的。那么，这类请求就可以走从库。</p></li></ol><p>你可能会说，这个方案是不是有点畏难和取巧的意思，但其实这个方案是用得最多的。</p><p>当然，这个方案最大的问题在于，有时候你会碰到“所有查询都不能是过期读”的需求，比如一些金融类的业务。这样的话，你就要放弃读写分离，所有读写压力都在主库，等同于放弃了扩展性。</p><p>因此接下来，我们来讨论的话题是：可以支持读写分离的场景下，有哪些解决过期读的方案，并分析各个方案的优缺点。</p><h1>Sleep 方案</h1><p>主库更新后，读从库之前先sleep一下。具体的方案就是，类似于执行一条select sleep(1)命令。</p><p>这个方案的假设是，大多数情况下主备延迟在1秒之内，做一个sleep可以有很大概率拿到最新的数据。</p><p>这个方案给你的第一感觉，很可能是不靠谱儿，应该不会有人用吧？并且，你还可能会说，直接在发起查询时先执行一条sleep语句，用户体验很不友好啊。</p><p>但，这个思路确实可以在一定程度上解决问题。为了看起来更靠谱儿，我们可以换一种方式。</p><p>以卖家发布商品为例，商品发布后，用Ajax（Asynchronous JavaScript + XML，异步JavaScript和XML）直接把客户端输入的内容作为“新的商品”显示在页面上，而不是真正地去数据库做查询。</p><p>这样，卖家就可以通过这个显示，来确认产品已经发布成功了。等到卖家再刷新页面，去查看商品的时候，其实已经过了一段时间，也就达到了sleep的目的，进而也就解决了过期读的问题。</p><p>也就是说，这个sleep方案确实解决了类似场景下的过期读问题。但，从严格意义上来说，这个方案存在的问题就是不精确。这个不精确包含了两层意思：</p><ol>
<li>
<p>如果这个查询请求本来0.5秒就可以在从库上拿到正确结果，也会等1秒；</p></li><li>
<p>如果延迟超过1秒，还是会出现过期读。</p></li></ol><p>看到这里，你是不是有一种“你是不是在逗我”的感觉，这个改进方案虽然可以解决类似Ajax场景下的过期读问题，但还是怎么看都不靠谱儿。别着急，接下来我就和你介绍一些更准确的方案。</p><h1>判断主备无延迟方案</h1><p>要确保备库无延迟，通常有三种做法。</p><p>通过前面的<a href=https://time.geekbang.org/column/article/76795>第25篇</a>文章，我们知道show slave status结果里的seconds_behind_master参数的值，可以用来衡量主备延迟时间的长短。</p><p>所以<strong>第一种确保主备无延迟的方法是，</strong>每次从库执行查询请求前，先判断seconds_behind_master是否已经等于0。如果还不等于0 ，那就必须等到这个参数变为0才能执行查询请求。</p><p>seconds_behind_master的单位是秒，如果你觉得精度不够的话，还可以采用对比位点和GTID的方法来确保主备无延迟，也就是我们接下来要说的第二和第三种方法。</p><p>如图3所示，是一个show slave status结果的部分截图。</p><p><img src=https://static001.geekbang.org/resource/image/00/c1/00110923007513e865d7f43a124887c1.png alt></p><center><span class=reference>图3 show slave status结果</span></center><p>现在，我们就通过这个结果，来看看具体如何通过对比位点和GTID来确保主备无延迟。</p><p><strong>第二种方法，</strong>对比位点确保主备无延迟：</p><ul>
<li>Master_Log_File和Read_Master_Log_Pos，表示的是读到的主库的最新位点；</li><li>Relay_Master_Log_File和Exec_Master_Log_Pos，表示的是备库执行的最新位点。</li></ul><p>如果Master_Log_File和Relay_Master_Log_File、Read_Master_Log_Pos和Exec_Master_Log_Pos这两组值完全相同，就表示接收到的日志已经同步完成。</p><p><strong>第三种方法，</strong>对比GTID集合确保主备无延迟：</p><ul>
<li>Auto_Position=1 ，表示这对主备关系使用了GTID协议。</li><li>Retrieved_Gtid_Set，是备库收到的所有日志的GTID集合；</li><li>Executed_Gtid_Set，是备库所有已经执行完成的GTID集合。</li></ul><p>如果这两个集合相同，也表示备库接收到的日志都已经同步完成。</p><p>可见，对比位点和对比GTID这两种方法，都要比判断seconds_behind_master是否为0更准确。</p><p>在执行查询请求之前，先判断从库是否同步完成的方法，相比于sleep方案，准确度确实提升了不少，但还是没有达到“精确”的程度。为什么这么说呢？</p><p>我们现在一起来回顾下，一个事务的binlog在主备库之间的状态：</p><ol>
<li>
<p>主库执行完成，写入binlog，并反馈给客户端；</p></li><li>
<p>binlog被从主库发送给备库，备库收到；</p></li><li>
<p>在备库执行binlog完成。</p></li></ol><p>我们上面判断主备无延迟的逻辑，是“备库收到的日志都执行完成了”。但是，从binlog在主备之间状态的分析中，不难看出还有一部分日志，处于客户端已经收到提交确认，而备库还没收到日志的状态。</p><p>如图4所示就是这样的一个状态。</p><p><img src=https://static001.geekbang.org/resource/image/55/9e/557445207b57d6c0f2747509d7d6619e.png alt></p><center><span class=reference>图4 备库还没收到trx3</span></center><p>这时，主库上执行完成了三个事务trx1、trx2和trx3，其中：</p><ol>
<li>
<p>trx1和trx2已经传到从库，并且已经执行完成了；</p></li><li>
<p>trx3在主库执行完成，并且已经回复给客户端，但是还没有传到从库中。</p></li></ol><p>如果这时候你在从库B上执行查询请求，按照我们上面的逻辑，从库认为已经没有同步延迟，但还是查不到trx3的。严格地说，就是出现了过期读。</p><p>那么，这个问题有没有办法解决呢？</p><h1>配合semi-sync</h1><p>要解决这个问题，就要引入半同步复制，也就是semi-sync replication。</p><p>semi-sync做了这样的设计：</p><ol>
<li>
<p>事务提交的时候，主库把binlog发给从库；</p></li><li>
<p>从库收到binlog以后，发回给主库一个ack，表示收到了；</p></li><li>
<p>主库收到这个ack以后，才能给客户端返回“事务完成”的确认。</p></li></ol><p>也就是说，如果启用了semi-sync，就表示所有给客户端发送过确认的事务，都确保了备库已经收到了这个日志。</p><p>在<a href=https://time.geekbang.org/column/article/76795>第25篇文章</a>的评论区，有同学问到：如果主库掉电的时候，有些binlog还来不及发给从库，会不会导致系统数据丢失？</p><p>答案是，如果使用的是普通的异步复制模式，就可能会丢失，但semi-sync就可以解决这个问题。</p><p>这样，semi-sync配合前面关于位点的判断，就能够确定在从库上执行的查询请求，可以避免过期读。</p><p>但是，semi-sync+位点判断的方案，只对一主一备的场景是成立的。在一主多从场景中，主库只要等到一个从库的ack，就开始给客户端返回确认。这时，在从库上执行查询请求，就有两种情况：</p><ol>
<li>
<p>如果查询是落在这个响应了ack的从库上，是能够确保读到最新数据；</p></li><li>
<p>但如果是查询落到其他从库上，它们可能还没有收到最新的日志，就会产生过期读的问题。</p></li></ol><p>其实，判断同步位点的方案还有另外一个潜在的问题，即：如果在业务更新的高峰期，主库的位点或者GTID集合更新很快，那么上面的两个位点等值判断就会一直不成立，很可能出现从库上迟迟无法响应查询请求的情况。</p><p>实际上，回到我们最初的业务逻辑里，当发起一个查询请求以后，我们要得到准确的结果，其实并不需要等到“主备完全同步”。</p><p>为什么这么说呢？我们来看一下这个时序图。</p><p><img src=https://static001.geekbang.org/resource/image/9c/09/9cf54f3e91dc8f7b8947d7d8e384aa09.png alt></p><center><span class=reference>图5 主备持续延迟一个事务</span></center><p>图5所示，就是等待位点方案的一个bad case。图中备库B下的虚线框，分别表示relaylog和binlog中的事务。可以看到，图5中从状态1 到状态4，一直处于延迟一个事务的状态。</p><p>备库B一直到状态4都和主库A存在延迟，如果用上面必须等到无延迟才能查询的方案，select语句直到状态4都不能被执行。</p><p>但是，其实客户端是在发完trx1更新后发起的select语句，我们只需要确保trx1已经执行完成就可以执行select语句了。也就是说，如果在状态3执行查询请求，得到的就是预期结果了。</p><p>到这里，我们小结一下，semi-sync配合判断主备无延迟的方案，存在两个问题：</p><ol>
<li>
<p>一主多从的时候，在某些从库执行查询请求会存在过期读的现象；</p></li><li>
<p>在持续延迟的情况下，可能出现过度等待的问题。</p></li></ol><p>接下来，我要和你介绍的等主库位点方案，就可以解决这两个问题。</p><h1>等主库位点方案</h1><p>要理解等主库位点方案，我需要先和你介绍一条命令：</p><pre><code>select master_pos_wait(file, pos[, timeout]);
</code></pre><p>这条命令的逻辑如下：</p><ol>
<li>
<p>它是在从库执行的；</p></li><li>
<p>参数file和pos指的是主库上的文件名和位置；</p></li><li>
<p>timeout可选，设置为正整数N表示这个函数最多等待N秒。</p></li></ol><p>这个命令正常返回的结果是一个正整数M，表示从命令开始执行，到应用完file和pos表示的binlog位置，执行了多少事务。</p><p>当然，除了正常返回一个正整数M外，这条命令还会返回一些其他结果，包括：</p><ol>
<li>
<p>如果执行期间，备库同步线程发生异常，则返回NULL；</p></li><li>
<p>如果等待超过N秒，就返回-1；</p></li><li>
<p>如果刚开始执行的时候，就发现已经执行过这个位置了，则返回0。</p></li></ol><p>对于图5中先执行trx1，再执行一个查询请求的逻辑，要保证能够查到正确的数据，我们可以使用这个逻辑：</p><ol>
<li>
<p>trx1事务更新完成后，马上执行show master status得到当前主库执行到的File和Position；</p></li><li>
<p>选定一个从库执行查询语句；</p></li><li>
<p>在从库上执行select master_pos_wait(File, Position, 1)；</p></li><li>
<p>如果返回值是>=0的正整数，则在这个从库执行查询语句；</p></li><li>
<p>否则，到主库执行查询语句。</p></li></ol><p>我把上面这个流程画出来。</p><p><img src=https://static001.geekbang.org/resource/image/b2/57/b20ae91ea46803df1b63ed683e1de357.png alt></p><center><span class=reference>图6 master_pos_wait方案</span></center><p>这里我们假设，这条select查询最多在从库上等待1秒。那么，如果1秒内master_pos_wait返回一个大于等于0的整数，就确保了从库上执行的这个查询结果一定包含了trx1的数据。</p><p>步骤5到主库执行查询语句，是这类方案常用的退化机制。因为从库的延迟时间不可控，不能无限等待，所以如果等待超时，就应该放弃，然后到主库去查。</p><p>你可能会说，如果所有的从库都延迟超过1秒了，那查询压力不就都跑到主库上了吗？确实是这样。</p><p>但是，按照我们设定不允许过期读的要求，就只有两种选择，一种是超时放弃，一种是转到主库查询。具体怎么选择，就需要业务开发同学做好限流策略了。</p><h1>GTID方案</h1><p>如果你的数据库开启了GTID模式，对应的也有等待GTID的方案。</p><p>MySQL中同样提供了一个类似的命令：</p><pre><code> select wait_for_executed_gtid_set(gtid_set, 1);
</code></pre><p>这条命令的逻辑是：</p><ol>
<li>
<p>等待，直到这个库执行的事务中包含传入的gtid_set，返回0；</p></li><li>
<p>超时返回1。</p></li></ol><p>在前面等位点的方案中，我们执行完事务后，还要主动去主库执行show master status。而MySQL 5.7.6版本开始，允许在执行完更新类事务后，把这个事务的GTID返回给客户端，这样等GTID的方案就可以减少一次查询。</p><p>这时，等GTID的执行流程就变成了：</p><ol>
<li>
<p>trx1事务更新完成后，从返回包直接获取这个事务的GTID，记为gtid1；</p></li><li>
<p>选定一个从库执行查询语句；</p></li><li>
<p>在从库上执行 select wait_for_executed_gtid_set(gtid1, 1)；</p></li><li>
<p>如果返回值是0，则在这个从库执行查询语句；</p></li><li>
<p>否则，到主库执行查询语句。</p></li></ol><p>跟等主库位点的方案一样，等待超时后是否直接到主库查询，需要业务开发同学来做限流考虑。</p><p>我把这个流程图画出来。</p><p><img src=https://static001.geekbang.org/resource/image/d5/39/d521de8017297aff59db2f68170ee739.png alt></p><center><span class=reference>图7 wait_for_executed_gtid_set方案</span></center><p>在上面的第一步中，trx1事务更新完成后，从返回包直接获取这个事务的GTID。问题是，怎么能够让MySQL在执行事务后，返回包中带上GTID呢？</p><p>你只需要将参数session_track_gtids设置为OWN_GTID，然后通过API接口mysql_session_track_get_first从返回包解析出GTID的值即可。</p><p>在专栏的<a href=https://time.geekbang.org/column/article/68319>第一篇文章</a>中，我介绍mysql_reset_connection的时候，评论区有同学留言问这类接口应该怎么使用。</p><p>这里我再回答一下。其实，MySQL并没有提供这类接口的SQL用法，是提供给程序的API(<a href=https://dev.mysql.com/doc/refman/5.7/en/c-api-functions.html>https://dev.mysql.com/doc/refman/5.7/en/c-api-functions.html</a>)。</p><p>比如，为了让客户端在事务提交后，返回的GITD能够在客户端显示出来，我对MySQL客户端代码做了点修改，如下所示：</p><p><img src=https://static001.geekbang.org/resource/image/97/63/973bdd8741f830acebe005cbf37a7663.png alt></p><center><span class=reference>图8 显示更新事务的GTID--代码</span></center><p>这样，就可以看到语句执行完成，显示出GITD的值。</p><p><img src=https://static001.geekbang.org/resource/image/25/fe/253106d31d9d97aaa2846b2015f593fe.png alt></p><center><span class=reference>图9 显示更新事务的GTID--效果</span></center><p>当然了，这只是一个例子。你要使用这个方案的时候，还是应该在你的客户端代码中调用mysql_session_track_get_first这个函数。</p><h1>小结</h1><p>在今天这篇文章中，我跟你介绍了一主多从做读写分离时，可能碰到过期读的原因，以及几种应对的方案。</p><p>这几种方案中，有的方案看上去是做了妥协，有的方案看上去不那么靠谱儿，但都是有实际应用场景的，你需要根据业务需求选择。</p><p>即使是最后等待位点和等待GTID这两个方案，虽然看上去比较靠谱儿，但仍然存在需要权衡的情况。如果所有的从库都延迟，那么请求就会全部落到主库上，这时候会不会由于压力突然增大，把主库打挂了呢？</p><p>其实，在实际应用中，这几个方案是可以混合使用的。</p><p>比如，先在客户端对请求做分类，区分哪些请求可以接受过期读，而哪些请求完全不能接受过期读；然后，对于不能接受过期读的语句，再使用等GTID或等位点的方案。</p><p>但话说回来，过期读在本质上是由一写多读导致的。在实际应用中，可能会有别的不需要等待就可以水平扩展的数据库方案，但这往往是用牺牲写性能换来的，也就是需要在读性能和写性能中取权衡。</p><p>最后 ，我给你留下一个问题吧。</p><p>假设你的系统采用了我们文中介绍的最后一个方案，也就是等GTID的方案，现在你要对主库的一张大表做DDL，可能会出现什么情况呢？为了避免这种情况，你会怎么做呢？</p><p>你可以把你的分析和方案设计写在评论区，我会在下一篇文章跟你讨论这个问题。感谢你的收听，也欢迎你把这篇文章分享给更多的朋友一起阅读。</p><h1>上期问题时间</h1><p>上期给你留的问题是，在GTID模式下，如果一个新的从库接上主库，但是需要的binlog已经没了，要怎么做？</p><p>@某、人同学给了很详细的分析，我把他的回答略做修改贴过来。</p><ol>
<li>
<p>如果业务允许主从不一致的情况，那么可以在主库上先执行show global variables like ‘gtid_purged’，得到主库已经删除的GTID集合，假设是gtid_purged1；然后先在从库上执行reset master，再执行set global gtid_purged =‘gtid_purged1’；最后执行start slave，就会从主库现存的binlog开始同步。binlog缺失的那一部分，数据在从库上就可能会有丢失，造成主从不一致。</p></li><li>
<p>如果需要主从数据一致的话，最好还是通过重新搭建从库来做。</p></li><li>
<p>如果有其他的从库保留有全量的binlog的话，可以把新的从库先接到这个保留了全量binlog的从库，追上日志以后，如果有需要，再接回主库。</p></li><li>
<p>如果binlog有备份的情况，可以先在从库上应用缺失的binlog，然后再执行start slave。</p></li></ol><p>评论区留言点赞板：</p><blockquote>
<p>@悟空 同学级联实验，验证了seconds_behind_master的计算逻辑。</p></blockquote><blockquote>
<p>@_CountingStars 问了一个好问题：MySQL是怎么快速定位binlog里面的某一个GTID位置的？答案是，在binlog文件头部的Previous_gtids可以解决这个问题。</p></blockquote><blockquote>
<p>@王朋飞 同学问了一个好问题，sql_slave_skip_counter跳过的是一个event，由于MySQL总不能执行一半的事务，所以既然跳过了一个event，就会跳到这个事务的末尾，因此set global sql_slave_skip_counter=1;start slave是可以跳过整个事务的。</p></blockquote><style>ul{list-style:none;display:block;list-style-type:disc;margin-block-start:1em;margin-block-end:1em;margin-inline-start:0;margin-inline-end:0;padding-inline-start:40px}li{display:list-item;text-align:-webkit-match-parent}._2sjJGcOH_0{list-style-position:inside;width:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-top:26px;border-bottom:1px solid rgba(233,233,233,.6)}._2sjJGcOH_0 ._3FLYR4bF_0{width:34px;height:34px;-ms-flex-negative:0;flex-shrink:0;border-radius:50%}._2sjJGcOH_0 ._36ChpWj4_0{margin-left:.5rem;-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;padding-bottom:20px}._2sjJGcOH_0 ._36ChpWj4_0 ._2zFoi7sd_0{font-size:16px;color:#3d464d;font-weight:500;-webkit-font-smoothing:antialiased;line-height:34px}._2sjJGcOH_0 ._36ChpWj4_0 ._2_QraFYR_0{margin-top:12px;color:#505050;-webkit-font-smoothing:antialiased;font-size:14px;font-weight:400;white-space:normal;word-break:break-all;line-height:24px}._2sjJGcOH_0 ._10o3OAxT_0{margin-top:18px;border-radius:4px;background-color:#f6f7fb}._2sjJGcOH_0 ._3klNVc4Z_0{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin-top:15px}._2sjJGcOH_0 ._10o3OAxT_0 ._3KxQPN3V_0{color:#505050;-webkit-font-smoothing:antialiased;font-size:14px;font-weight:400;white-space:normal;word-break:break-word;padding:20px 20px 20px 24px}._2sjJGcOH_0 ._3klNVc4Z_0{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin-top:15px}._2sjJGcOH_0 ._3Hkula0k_0{color:#b2b2b2;font-size:14px}</style><ul><li>
<div class=_2sjJGcOH_0>
<div class=_36ChpWj4_0>
<div class=_2zFoi7sd_0><span>有铭</span>
</div><div class=_2_QraFYR_0>这专栏真的是干货满满，每看一篇我都有“我发现我真的不会使用MySQL”和“我原来把MySQL用错了”的挫败感</div><div class=_10o3OAxT_0>
<p class=_3KxQPN3V_0>作者回复: 这样我觉得你和我的时间都值了😆<br><br>把你更新了认识的点发到评论区，这样会印象更深哈🤝<br></p></div><div class=_3klNVc4Z_0>
<div class=_3Hkula0k_0>2019-01-16 14:23:42</div></div></div></div></li><li>
<div class=_2sjJGcOH_0>
<div class=_36ChpWj4_0>
<div class=_2zFoi7sd_0><span>曾剑</span>
</div><div class=_2_QraFYR_0>老师写的每一篇文章都能让我获益良多。每一篇都值得看好几遍。<br>今天的问题，大表做DDL的时候可能会出现主从延迟，导致等 GTID 的方案可能会导致这部分流量全打到主库，或者全部超时。<br>如果这部分流量太大的话，我会选择上一篇文章介绍的两种方法：<br>1.在各个从库先SET sql_log_bin = OFF，然后做DDL，所有从库及备主全做完之后，做主从切换，最后在原来的主库用同样的方式做DDL。<br>2.从库上执行DDL；将从库上执行DDL产生的GTID在主库上利用生成一个空事务GTID的方式将这个GTID在主库上生成出来。<br>各个从库做完之后再主从切换，然后再在原来的主库上同样做一次。<br>需要注意的是如果有MM架构的情况下，承担写职责的主库上的slave需要先停掉。</div><div class=_10o3OAxT_0>
<p class=_3KxQPN3V_0>作者回复: 👍 表示这两篇文章你都get到了</p></div><div class=_3klNVc4Z_0>
<div class=_3Hkula0k_0>2019-01-16 10:08:52</div></div></div></div></li><li>
<div class=_2sjJGcOH_0>
<div class=_36ChpWj4_0>
<div class=_2zFoi7sd_0><span>某、人</span>
</div><div class=_2_QraFYR_0>老师我先请教两个问题(估计大多数同学都有这个疑惑)😄:<br>1.现在的中间件可以说是乱花渐欲迷人眼,请问老师哪一款中间件适合大多数不分库分表,只是做读写分离业务的proxy,能推荐一款嘛?毕竟大多数公司都没有专门做中间件开发的团队<br>2.如果是业务上进行了分库分表,老师能推荐一款分库分表的proxy嘛？我目前了解到的针对分库分表的proxy都或多或少有些问题。不过分布式数据库是一个趋势也是一个难点。</div><div class=_10o3OAxT_0>
<p class=_3KxQPN3V_0>作者回复: 额，这个最难回答了<br><br>说实话因为我原来团队是团队自己做的proxy（没有开源），所以我对其他proxy用得并不多，实在不敢随便指一个。<br><br>如果我说个比较熟悉的话，可能MariaDB MaxScale还不错</p></div><div class=_3klNVc4Z_0>
<div class=_3Hkula0k_0>2019-01-16 23:12:06</div></div></div></div></li><li>
<div class=_2sjJGcOH_0>
<div class=_36ChpWj4_0>
<div class=_2zFoi7sd_0><span>易翔</span>
</div><div class=_2_QraFYR_0>为老师一句你的时间和我的时间都值了。点赞</div><div class=_10o3OAxT_0>
</div><div class=_3klNVc4Z_0>
<div class=_3Hkula0k_0>2019-01-16 21:53:50</div></div></div></div></li><li>
<div class=_2sjJGcOH_0>
<div class=_36ChpWj4_0>
<div class=_2zFoi7sd_0><span>狼猫</span>
</div><div class=_2_QraFYR_0>全网最好的课程，没有之一，不接受反驳</div><div class=_10o3OAxT_0>
</div><div class=_3klNVc4Z_0>
<div class=_3Hkula0k_0>2019-06-24 12:20:55</div></div></div></div></li><li>
<div class=_2sjJGcOH_0>
<div class=_36ChpWj4_0>
<div class=_2zFoi7sd_0><span>Mr.Strive.Z.H.L</span>
</div><div class=_2_QraFYR_0>老师您好：<br>关于主库大表的DDL操作，我看了问题答案，有两种方案。第一种是读写请求转到主库，在主库上做DDL。第二种是从库上做DDL，完成后进行主从切换。<br><br>关于第二种，有一个疑惑：<br>从库上做DDL，读写请求走主库，等到从库完成后，从库必须要同步DDL期间，主库完成的事务后才能进行主从切换。而如果DDL操作是删除一列，那么在同步过程中会出错呀？（比如抛出这一列不存在的错误）。</div><div class=_10o3OAxT_0>
<p class=_3KxQPN3V_0>作者回复: 你说得对，这种方案下能支持的DDL只有以下几种：<br> 创建&amp;#47;删除索引、新增最后一列、删除最后一列<br><br>其中DBA会认为“合理”的DDL需求就是： “创建&amp;#47;删除索引、新增最后一列”<br><br>新春快乐~</p></div><div class=_3klNVc4Z_0>
<div class=_3Hkula0k_0>2019-01-21 11:25:28</div></div></div></div></li><li>
<div class=_2sjJGcOH_0>
<div class=_36ChpWj4_0>
<div class=_2zFoi7sd_0><span>猪哥哥</span>
</div><div class=_2_QraFYR_0>老师, 你真棒, 我公司的生产环境解决过期读使用的就是强制走主库方案, 看了这篇文章, 困惑了很久的问题迎刃而解！很感谢!</div><div class=_10o3OAxT_0>
</div><div class=_3klNVc4Z_0>
<div class=_3Hkula0k_0>2019-01-17 11:08:56</div></div></div></div></li><li>
<div class=_2sjJGcOH_0>
<div class=_36ChpWj4_0>
<div class=_2zFoi7sd_0><span>钱</span>
</div><div class=_2_QraFYR_0>1：单机的性能总是有限的，所以，就出现了读写分离<br>2：读写分离带来了更高的性能，也引入了数据不一致的问题<br>3：为了数据一致性，又产生了各种解决方案<br>人少力量小，人多了事就多，如果管理能力好，还是人多好办事。<br>原理是这样，没怎么实操过，感谢老师的分享，让自己的认知边界有移动了一点点。</div><div class=_10o3OAxT_0>
<p class=_3KxQPN3V_0>作者回复: 👍</p></div><div class=_3klNVc4Z_0>
<div class=_3Hkula0k_0>2019-08-04 12:13:33</div></div></div></div></li><li>
<div class=_2sjJGcOH_0>
<div class=_36ChpWj4_0>
<div class=_2zFoi7sd_0><span>二马</span>
</div><div class=_2_QraFYR_0>最近做性能测试时发现当并发用户达到一定量(比如500)，部分用户连接不上，能否介绍下MySQL连接相关问题，谢谢！</div><div class=_10o3OAxT_0>
<p class=_3KxQPN3V_0>作者回复: 修改max_connections参数</p></div><div class=_3klNVc4Z_0>
<div class=_3Hkula0k_0>2019-01-16 07:31:13</div></div></div></div></li><li>
<div class=_2sjJGcOH_0>
<div class=_36ChpWj4_0>
<div class=_2zFoi7sd_0><span>Max</span>
</div><div class=_2_QraFYR_0>我一般是先是在从库上设置 set_log_bin=off，然后执行ddl,语句。<br>然后完成以后，主从做一下切换。然后在主库上在执行一下set_log_bin=off,执行ddl语句。<br>然后在做一下主从切换。<br>个人对pt-online-scheman-change不是很推荐使用，它的原理基本是创建触发器，然后创建和旧表一样结构的数据表，<br>把旧表的数据复制过去。最后删除旧表。以前做个一个测试，如果旧表一直在被select,删除过程会一直会等待。<br>所以个人不是很建议。万一不小心变成从删库到路步，那就得不偿失了。<br><br>老师，有个问题想请教一下，一主多从可以多到什么地步，以前我们CTO解决的方案就是加机器，一主十三从。<br>当时我是反对的，其实个人建议还是从SQL，业务上面去优化。而不是一味的加机器。如果加机器解决的话，还要DBA做什么呢？</div><div class=_10o3OAxT_0>
<p class=_3KxQPN3V_0>作者回复: 前面的分析很好哈<br><br><br>然后一主13从有点多了，否则主库生成binlog太快的话，主库的网卡会被打爆。要这么多的话，得做级联。<br><br>DBA解决不能靠加机器解决的事情^_^ 而且如果通过优化，可以把13变成3，那也是DBA的价值</p></div><div class=_3klNVc4Z_0>
<div class=_3Hkula0k_0>2019-01-17 16:17:35</div></div></div></div></li><li>
<div class=_2sjJGcOH_0>
<div class=_36ChpWj4_0>
<div class=_2zFoi7sd_0><span>万勇</span>
</div><div class=_2_QraFYR_0>老师，请教下。<br>1.对大表做ddl，是可以采用先在备库上set global log_bin=off，先做完ddl，然后切换主备库。为了保证数据一致性，在切主备的时候，数据库会有个不可用的时间段，对业务会造成影响。现在的架构方式，中间层还有proxy，意味着proxy也需要修改主备配置，做reload。这样做的话，感觉成本太高，在真正的生产环境中，这种方法适用吗？<br>2.目前我们常采用的是对几百万以上的表用pt-online-schema-change，这种方式会产生大量的binlog，业务高峰期不能做，会引起主备延迟。在生产业务中，我觉得等主库节点或者等gtid这种方案挺不错，至少能保证业务，但也会增加主库的压力。<br>3.5.7版本出的group_replication多写模式性能不知道如何？架构变动太大，还不敢上。<br></div><div class=_10o3OAxT_0>
<p class=_3KxQPN3V_0>作者回复: 1. 是这样的，我们说的是，如果非紧急情况下，还是尽量用gh-ost，在“紧急”的情况下，才这么做；确实是要绕过proxy的，也就是说，这事儿是要负责运维的同学做；<br>2. pt工具是有这个问题，试一下gh-ost哈；group_replication多写模式国内我还没有听到国内有公司在生产上大规模用的，如果你有使用经验，分享一下哈</p></div><div class=_3klNVc4Z_0>
<div class=_3Hkula0k_0>2019-01-16 17:22:24</div></div></div></div></li><li>
<div class=_2sjJGcOH_0>
<div class=_36ChpWj4_0>
<div class=_2zFoi7sd_0><span>Zhaoyang</span>
</div><div class=_2_QraFYR_0>最近这几篇文章，真是看的我比较辛苦，因为我平时的业务都是增删改查，而且，有DBA同学呢，所以主从这里我接触的非常少，我顶多也就考虑一下主从不同步的问题。其他问题我都不会想到。也不会知道怎么解决。<br>那我接下来还是先把专栏过一遍把，先留个大概其的印象，目前来说并没有搞懂，因为自己确实没有经历过。</div><div class=_10o3OAxT_0>
</div><div class=_3klNVc4Z_0>
<div class=_3Hkula0k_0>2020-01-27 11:08:28</div></div></div></div></li><li>
<div class=_2sjJGcOH_0>
<div class=_36ChpWj4_0>
<div class=_2zFoi7sd_0><span>天下第七</span>
</div><div class=_2_QraFYR_0>这绝对极客时间最干货的专栏，内容+评论都是高精，原来我不会MySQL，我对MySQL一无所知，惭愧惭愧。</div><div class=_10o3OAxT_0>
</div><div class=_3klNVc4Z_0>
<div class=_3Hkula0k_0>2020-10-17 16:44:09</div></div></div></div></li><li>
<div class=_2sjJGcOH_0>
<div class=_36ChpWj4_0>
<div class=_2zFoi7sd_0><span>Charles | 姜海龙</span>
</div><div class=_2_QraFYR_0>这专栏真的是干货满满，每看一篇我都有“我发现我真的不会使用MySQL”和“我原来把MySQL用错了”的挫败感</div><div class=_10o3OAxT_0>
</div><div class=_3klNVc4Z_0>
<div class=_3Hkula0k_0>2019-08-12 11:29:00</div></div></div></div></li><li>
<div class=_2sjJGcOH_0>
<div class=_36ChpWj4_0>
<div class=_2zFoi7sd_0><span>啊啊啊哦哦</span>
</div><div class=_2_QraFYR_0>老师。最近公司在阿里云要用 一主多从。 我想问下阿里的。 select *from test for update 会定位到主库吗</div><div class=_10o3OAxT_0>
<p class=_3KxQPN3V_0>作者回复: 设计不出bug的话，应该要😆</p></div><div class=_3klNVc4Z_0>
<div class=_3Hkula0k_0>2019-04-10 19:35:10</div></div></div></div></li><li>
<div class=_2sjJGcOH_0>
<div class=_36ChpWj4_0>
<div class=_2zFoi7sd_0><span>Dovelol</span>
</div><div class=_2_QraFYR_0>老师好，有几个问题想请教下，<br>1.如果不想有过期读，用等GTID的方案，那么每次查询都要有等GTID的相关操作，增加的这部分对性能有多少影响；<br>2.我们用的读写分离proxy不支持等GTID，那是不是自己要在客户端实现这部分逻辑，等于读写分离的架构既用了proxy，又在客户端做了相关策略，感觉这方案更适合有能力自研proxy的公司啊；<br>3.感觉目前大多数生产环境还是用的读主库这种方式避免过期读，如果只能用这种方案的话该怎么扩展mysql架构来避免主库压力太大呢。<br>我们是项目上线很久然后加的读写分离，好多service层代码写的不好，可以读从库的sql被写到了事务中，这样会被proxy转到主库上读，所以导致主库负担了好多读的sql，感觉读写分离不仅对mysql这块要掌握，整体的代码结构上也要有所调整吧。</div><div class=_10o3OAxT_0>
<p class=_3KxQPN3V_0>作者回复: 1. 这个等待时间其实就基本上是主备延迟的时间<br>2. 用了proxy这事情就得proxy做了，就不要客户端做了。没有gtid，可以用倒数第二种方法呀：）<br>3. 是的，其实“走主库”这种做法还挺多的。我之前看到有的公司的做法，就是直接拆库了。等于一套“一主多从”拆成多套。</p></div><div class=_3klNVc4Z_0>
<div class=_3Hkula0k_0>2019-01-16 14:14:13</div></div></div></div></li><li>
<div class=_2sjJGcOH_0>
<div class=_36ChpWj4_0>
<div class=_2zFoi7sd_0><span>杨</span>
</div><div class=_2_QraFYR_0>我主从库以前都不知道怎么实现的哈哈，看了老师的专栏学到了很多<br>如何开启gtid老师看看这个可以吗?<br>gtid_mode=ON<br>enforce_gtid_consistency=ON<br>http://blog.itpub.net/31429259/viewspace-2643665/<br>等库位点方案select master_pos_wait(File, Position, 1)我在mysql中执行不了是什么原因呀?<br>客户端代码中调用 mysql_session_track_get_first 这个函数?<br>这个我用java或者go怎么调用?直接java调用函数函数一样调用mysql_session_track_get_first吗</div><div class=_10o3OAxT_0>
</div><div class=_3klNVc4Z_0>
<div class=_3Hkula0k_0>2020-04-23 17:23:48</div></div></div></div></li><li>
<div class=_2sjJGcOH_0>
<div class=_36ChpWj4_0>
<div class=_2zFoi7sd_0><span>晓杰</span>
</div><div class=_2_QraFYR_0>看了判断主备无延迟这种方案，有个疑惑：<br>读写分离的读应该是读从库的吧，为什么是去判断主备无延迟，而不是判断主从的无延迟<br></div><div class=_10o3OAxT_0>
<p class=_3KxQPN3V_0>作者回复: 在说主备延迟/主从延迟的时候，从库和备库我当成同一个概念了😆</p></div><div class=_3klNVc4Z_0>
<div class=_3Hkula0k_0>2019-06-15 11:53:51</div></div></div></div></li><li>
<div class=_2sjJGcOH_0>
<div class=_36ChpWj4_0>
<div class=_2zFoi7sd_0><span>IceGeek17</span>
</div><div class=_2_QraFYR_0>老师，能不能分析下，如果去实现一个做读写分离的proxy，有哪些重要的点要考虑，比如：连接管理、流量分配管理、proxy自己的高可用，等等。<br>因为老师原来的团队自己开发过proxy，肯定有相关的经验，也趟过很多坑，能不能从如何实现一个proxy需要考虑哪些关键点，在架构上做一个分析和梳理</div><div class=_10o3OAxT_0>
<p class=_3KxQPN3V_0>作者回复: 额，这个问题有点大… 你提一个具体问题我们来讨论吧</p></div><div class=_3klNVc4Z_0>
<div class=_3Hkula0k_0>2019-01-29 10:25:36</div></div></div></div></li><li>
<div class=_2sjJGcOH_0>
<div class=_36ChpWj4_0>
<div class=_2zFoi7sd_0><span>SZQ</span>
</div><div class=_2_QraFYR_0>这一篇看了第三遍，还是看得头晕，等到猴年马月再回来看一下吧</div><div class=_10o3OAxT_0>
</div><div class=_3klNVc4Z_0>
<div class=_3Hkula0k_0>2021-09-06 11:18:30</div></div></div></div></li></ul><footer class=footline>
</footer></div></div><div id=navigation>
<a class="nav nav-prev" href=/1/27/ title=27_主库出问题了，从库怎么办？> <i class="fa fa-chevron-left"></i></a>
<a class="nav nav-next" href=/1/29/ title=29_如何判断一个数据库是不是出问题了？ style=margin-right:0><i class="fa fa-chevron-right"></i></a>
</div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px>
<div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1646795377></script>
<script src=/js/perfect-scrollbar.min.js?1646795377></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1646795377></script>
<script src=/js/jquery.sticky.js?1646795377></script>
<script src=/js/featherlight.min.js?1646795377></script>
<script src=/js/highlight.pack.js?1646795377></script>
<script>hljs.initHighlightingOnLoad()</script>
<script src=/js/modernizr.custom-3.6.0.js?1646795377></script>
<script src=/js/learn.js?1646795377></script>
<script src=/js/hugo-learn.js?1646795377></script>
<script src=/mermaid/mermaid.js?1646795377></script>
<script>mermaid.initialize({startOnLoad:!0})</script>
</body></html>